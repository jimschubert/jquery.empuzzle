(function(a){a.extend(a.expr[":"],{getPiece:function(b,c,d,e){return d&&d.length==4?a(b).attr("puzzle_id")==d[3]:null}});var b=function(c){var d=function(){},e={win:d,target:null,blank:"BR",randomize:d,size:6,DEBUG:!1},f=function(c,d,e){var f=d,g=f.squares,j=f.pieces,k=f.blank,l,m,n,o,p,q,r={duration:300};n=a(c).width(),o=a(c).height(),p=a(c).attr("puzzle_id"),q=a(k).attr("puzzle_id"),output=d.target,r=a.extend(r,f.anim);var s=function(b){var c,d;for(var e=0,f=g;e<f;e++)for(var h=0;h<f;h++){var i=b[e][h];a(i).attr("puzzle_id")==q&&(c={x:h,y:e}),a(i).attr("puzzle_id")==p&&(d={x:h,y:e});if(c&&d)return{blank:c,clicked:d}}return{blank:c,clicked:d}}(j);if(!s||!s.blank||!s.clicked)return;s.blank.y==s.clicked.y?(l=Math.abs(s.blank.x-s.clicked.x),m=s.blank.x<s.clicked.x?"W":"E"):s.blank.x==s.clicked.x&&(l=Math.abs(s.blank.y-s.clicked.y),m=s.blank.y<s.clicked.y?"N":"S");if(l){var t=l+1,u=function(){t--,t<=0&&(h(f),i(f))},v=s.clicked,w={},x={};r.queue=!1,r.complete=function(a){if(a){var c=[];for(var d=2,e=arguments.length;d<e;d++)c.push(arguments[d]);return function(){b.log("[Curry] Function has been curried: "+a),u(),a.apply(this,c)}}return b.log("[Curry] No anim.complete function was specified."),u}(r.complete);if(b.Direction[m]>>1==1){var y=v.y,z=s.blank.x,A;if(m=="E"){b.log("[Move] Moving left by "+l+" squares."),w.left="+="+n,x.left="-="+n*l;for(var B=v.x;B<z;B++){var C=A||a(j[y][B]).attr("puzzle_id"),D=a(":getPiece("+C+")",output).stop().animate(w,r);A=D.next(":not(.blank)").attr("puzzle_id")||A,j[y][B+1]=D,D.removeClass("clicked")}}else{b.log("[Move] Moving right by "+l+" squares."),w.left="-="+n,x.left="+="+n*l;for(var B=v.x;B>z;B--){var C=A||a(j[y][B]).attr("puzzle_id"),D=a(":getPiece("+C+")",output).stop().animate(w,r);A=D.prev(":not(.blank)").attr("puzzle_id")||A,j[y][B-1]=D,D.removeClass("clicked")}}var E=a(":getPiece("+q+")",output).stop().animate(x,{duration:r.duration,queue:!1,complete:function(){j[y][v.x]=a(this),d.blank=this,u()}})}else{var B=v.x,z=s.blank.y,A,F=j[z][B];if(m=="N"){b.log("[Move] Moving up by "+l+" squares."),w.top="-="+o,x.top="+="+o*l;for(var y=z,G=v.y;y<G;y++){var C=a(j[y+1][B]).attr("puzzle_id"),D=a(":getPiece("+C+")",output).stop().animate(w,r);j[y][B]=D,D.removeClass("clicked")}}else{b.log("[Move] Moving down by "+l+" squares."),w.top="+="+o,x.top="-="+o*l;for(var y=z,G=v.y;y>G;y--){var C=a(j[y-1][B]).attr("puzzle_id"),D=a(":getPiece("+C+")",output).stop().animate(w,r);j[y][B]=D,D.removeClass("clicked")}}var E=a(":getPiece("+q+")",output).stop().animate(x,{duration:r.duration,queue:!1,complete:function(){j[v.y][B]=a(this),d.blank=this,u()}})}}else b.log("no move")},g=function(b){var c=b.target,d=b.squares;b.pieces=new Array(d),a.each(b.pieces,function(a,c){b.pieces[a]=new Array});var e=a(".empuzzle_piece",c);for(var f=0,g=e.length;f<g;f++){var h=Math.floor(f/d);b.pieces[h].push(a(e[f]))}},h=function(c){b.log("[Draw]");var d=c.target,e=c.squares-1,f=c.pieces;d.html("");for(var h=0;h<=e;h++)for(var i=0;i<=e;i++)d.append(a(f[h][i]));g(c)},i=function(c){var d=c.pieces,e=c.validator,f=c.onWin,g=c.squares,h=!1;for(var i=0;i<g;i++)for(var j=0;j<g;j++){b.log("row:"+i+",column:"+j);var k=a(d[i][j]).attr("puzzle_id"),l=e[i*g+j];b.log("[Validate] current:"+k+", expecting: "+l),k!=l&&(h=!0)}h||f.call(this)},j=function(a){var b=a.target,c=a.pieces,d=a.squares,e=a.blank,f=Array.prototype.sort,g=new Array;for(var h=0;h<d;h++)g.push(new Array);for(var i=0;i<d;i++)for(var j=d-1;j>=0;j--)g[j][i]=c[i][j];var k=function(a,b){return a[1]<b[1]?1:a[0]>b[1]?-1:0};a.pieces=f.call(g,k)},k=function(c){var d,e=c.pieces,f=c.squares,g=c.blankLocation;switch(g){case b.Corner.TL:d=e[0][0],b.log("[Blank] TL: [0][0]");break;case b.Corner.TR:d=e[0][f-1],b.log("[Blank] TR: [0]["+(f-1)+"]");break;case b.Corner.BL:d=e[f-1][0],b.log("[Blank] BL: ["+(f-1)+"][0]");break;case b.Corner.BR:d=e[f-1][f-1],b.log("[Blank] BR: ["+(f-1)+"]["+(f-1)+"]")}return a(d).css({background:"none"}),a(d).addClass("blank"),a(d).html("<span></span>"),d},l=function(c,d,e,f,g){var h=e/g,i=f/g;a.each(d,function(d,e){a.each(e,function(e,f){a(f).css({top:d*i+c.top,left:e*h+c.left}),b.log(f)})})};return this.each(function(){a(this).load(function(){var g=a.extend({},e,c);b.log=function(a){g.DEBUG&&console&&typeof console.log=="function"&&console.log(a)};var i,m,n,o,p,q,r=b.Corner[g.blank]||"BR",s=g.target,t=g.size>0?g.size:e.size,u=g.randomize,v=[];this instanceof HTMLImageElement?m=a(this):m=a("img:first",this),n=m.width(),o=m.height(),p=m.attr("src");if(!s||s instanceof HTMLDocument){var w=a('<div class="empuzzle_target"></div>');m.after(w),s=a(m).siblings(".empuzzle_target:first")}a(m).hide(),a(s).width(n),a(s).height(o),q=a(s).offset();var x=new Array;for(var y=0,z=t,A=n/t,B=o/t;y<z;y++){x.push(new Array(t));for(var C=0;C<z;C++){var D=a('<div class="empuzzle_piece"></div>');D.css({position:"absolute",background:"url('"+p+"') "+A*C*-1+"px "+B*y*-1+"px",height:B+"px",width:A+"px",cursor:"pointer"});var E=Math.random();v.push(E),D.attr("puzzle_id",E),x[y][C]=D}}i={target:s,pieces:x,squares:t,blankLocation:r,validator:v,onWin:g.win,anim:g.anim||{},DEBUG:g.DEBUG},i.blank=k.call(this,i),u!==d?u.call(this,i,j):j.call(this,i),l(q,i.pieces,n,o,t),a(".empuzzle_piece",i.output).live("click",function(){var c=f;a(this).addClass("clicked"),c.call(b,this,i)}),h.call(this,i)})})};b.Corner={TL:1,TR:2,BL:3,BR:4},b.Direction={N:4,E:2,S:4,W:2},a.fn.empuzzle=b})(jQuery)